<html>
<script>
  
  (function(){
    // Hard coded database name
    var DB_NAME = 'pjs';
    // Hard coded table name
    var PAGESTORE_NAME = 'html';
    // Current schema version. This goes up when the schema changes
    var SCHEMA_VERSION = 2;

    // Chrome incorrectly interprets hashtags as part of URL for blob urls. This is ghetto hash tag method:
    var url = window.location.pathname.split('#').pop();
    
    function connectDb(cb){
      var request = indexedDB.open(DB_NAME, SCHEMA_VERSION);
    
      // Ensure that we have the correct schema, if not create the correct schema
      request.onupgradeneeded = function(e) {
        var db = e.target.result;
        if (db.objectStoreNames.contains(PAGESTORE_NAME)) {
          db.deleteObjectStore(PAGESTORE_NAME);
        }
        // Tables will be keyed by file URL
        var store = db.createObjectStore(PAGESTORE_NAME, {keyPath: 'url'});
      };

      // Upon successful opening of database, store reference to the database
      request.onsuccess = function(e) {
        db = e.target.result;
        db.onerror = function(e) {
          console.log('Database error', e);
        };
        // DB ready to use
        
        // Get and render url given in hashtag
        return cb(null, db);
      };
      
      request.onerror = function(e) {
        console.log('Database openning error', e);
      };
      
    }
    function getFile(db, url, cb){
      console.log('Getting file', url);
      // Begin database transaction
      var transaction = db.transaction([PAGESTORE_NAME]);
      var objectStore = transaction.objectStore(PAGESTORE_NAME);
      
      // Get file keyed by provided url
      var request = objectStore.get(url);
      request.onerror = function(event) {
        // Handle errors!
        return cb(new Error(event), null);
      };
      request.onsuccess = function(event) {
        // Do something with the request.result!
        var result = event.target.result;
      
        if (!result) {
          return cb(new Error('No file'), null);
          // Successfully found valid file
        } else {
          return cb(null, result);
        }
      };
    }
    function renderDom(html) {
      // TODO:
      // Switch out old images for prefetched images before rendering
      
      document.documentElement.innerHTML = html;
      var scripts = document.querySelectorAll('script');
      for (var i = 0; i < scripts.length; i++) {
        var oldScript = scripts[i];
        var newScript = document.createElement('script');
        newScript.src = oldScript.src;
        var script = document.createTextNode(oldScript.innerHTML);
        newScript.appendChild(script);
        newScript.async = oldScript.async;
        oldScript.parentNode.appendChild(newScript);
        oldScript.remove();
      }
    }
    
    function setState(url) {
      window.history.replaceState({}, '', window.location.origin + '/' + url);
    }
    
    function fallback() {
      console.log('Failed to load page');
      // Redirect user to actual page
      // window.location.replace(window.location.origin + '/' + url);
    }
    
    
    // Do stuff
    connectDb(function(err, db){
      if (err) {
        fallback();
        return;
      }
      getFile(db, url, function(err, file){
        if (err) {
          fallback();
          return;
        }
        setState(url);
        renderDom(file.data);
      });
    });
    
    /*
    Testing function for browser. It's here because I don't have anywhere else to stow it
    function createTestLink() {
      $.get('render.html', function(data){
        console.log(data);
        data = new Blob([data], {type: 'text/html'});
        console.log(data);
        data = URL.createObjectURL(data);
        console.log(data);
        $('<a></a>', {href: data + '#projects.html'}).text('asdf').appendTo('body');
      });
    }*/
    
  })()
</script>
</html>

